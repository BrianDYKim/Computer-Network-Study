## 목차

[3.2.0 개요](#320-개요)</br> [3.2.1 비연결형 다중화와 역다중화](#321-비연결형-다중화와-역다중화)</br> [3.2.2 연결지향형 다중화와 역다중화](#322-연결지향형-다중화와-역다중화)</br> [3.2.3 웹서버와 TCP](#323-웹서버와-TCP)</br>

## 3.2.0 개요

목적지 호스트로 전달된 세그먼트가 목적지 호스트에서 실행되고 있는 여러 애플리케이션 중 하나의 어떤 프로세스로 어떻게 전달되는지 트랜스포트 계층의 입장에서 설명한다.

트랜스포트 계층은 프로세스에게 직접 데이터를 전달하는 것이 아니라 각 프로세스가 갖고 있는 소켓을 통해 데이터를 전달한다. 트랜스포트 계층이 UDP인지, TCP인지에 따라 소켓을 식별하는 방식이 약간 다르다.

각각의 트랜스포트 계층 세그먼트는 필드집합을 가지고 있고 트랜스포트 계층에서 각 필드를 식별하여 세그먼트의 데이터를 올바른 소켓으로 전달하는 것을 역다중화 (demultiplexing)이라고 한다. 반면, 소켓으로부터 데이터를 모으고 세그먼트를 생성을 위해 각 데이터에 헤더 정보로 캡슐화 하고 세그먼트들을 네트워크 계층으로 전달하는 작업을 다중화 (multiplexing) 이라고 한다.

- 역다중화: 세그먼트 헤더필드 점검 -> 알맞은 소켓으로 전달
- 다중화: 송신할 세그먼트에 헤더정보 캡슐화 -> 네트워크 계층으로 전달

## 3.2.1 비연결형 다중화와 역다중화

비연결형인 UDP에서 UDP소켓에 1024~65535 중 미사용중인 포트번호가 할당되는데, 개발자가 명시하지 않아도 운영체제가 작업을 대신 수행하여 할당한다. 일반적으로 서버측은 특정포트번호를 할당한다.

송신호스트의 트랜스포트 계층은 세그먼트를 구성하는데 "애플리케이션 데이터(메시지)" + "출발지PORT" + "목적지PORT" + 다른2개의 값을 포함하는 세그먼트를 생성한다.

수신호스트는 <u>목적지PORT</u>를 검사하고 여러 프로세스 중 UDP소켓과 연관된 포트번호로 전달한다. 만약 2개의 UDP세그먼트의 출발지IP와 출발지PORT가 모두 혹은 각각 다를지라도 <u>동일한 목적지IP와 목적지PORT를 갖기만</u> 한다면 같은 목적지 소켓을 통해 동일한 프로세스로 향한다.

## 3.2.2 연결지향형 다중화와 역다중화

비연결형인 UDP는 목적지 IP와 PORT만 같다면 동일한 소켓을 이용했다. 이와 다른 TCP의 경우, 결론부터 말하자면 4개의 요소들의 집합 (four tuple) 즉, <u>출발지IP 와 PORT, 목적지IP 와 PORT로 소켓을 식별한다.</u> 즉, 전달받은 세그먼트를 역다중화 하기위해 4개의 값을 모두 사용한다.

TCP 역다중화의 동작원리는 다음과 같다.

- TCP연결에 대한 설정이 되기 이전부터 가동되고 있는 서버 애플리케이션 프로세스는 <u>**"웰컴 소켓"**</u>을 가지고 있고, 이 소켓은 특정 포트번호를 가진 TCP 클라이언트로부터 **연결설정 요청에 대기한다.**
- 목적지 호스트의 포트번호를 가진 연결요청 세그먼트가 수신되면 연결을 대기하던 서버 프로세스를 찾는다. 그러면 그 서버는 새로운 소켓을 생성한다. 이후 새로운 소켓에 대해 3방향 핸드셰이크 동작을 한다.
- 서버는 이후 요청에 대해 4가지 식별값을 통해서 소켓을 식별하여 역다중화가 이루어진다.

## 3.2.3 웹서버와 TCP

서버는 각기 다른 클라이언트가 보낸 세그먼트를 출발지IP와 출발지PORT로 구별한다. 서버는 각각의 연결에 따라 새로운 프로세스를 만들며 이들 프로세스는 각자의 연결소켓을 가진다. 그러나 소켓-프로세스 사이에 항상 1:1 대응이 이루어지는 것은 아니며, 실제로 오늘날의 많은 고성능 웹서버들은 하나의 프로세스만 사용한다. 단지 새로운 연결소켓과 함께 새로운 스레드를 생성한다. 따라서 웹서버에서 하나의 동일한 프로세스에 첨부된 많은 연결소켓들이 동시에 존재할 수도 있다.
